<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timetable Builder</title>

    <link rel="stylesheet" href="css/normalize.css" />
    <link rel="stylesheet" href="css/foundation.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/select2/3.4.6/select2.css" />
    <link rel="stylesheet" href="css/styles.css" />

    <script src="js/vendor/modernizr.js"></script>
  </head>
  <body>
    <div class="nav-div">
      <dl class="tabs dl-nav-tab" data-tab>
        <dd class="active"><a href="#module-finder">Module Finder</a></dd>
        <dd><a href="#timetable-builder">Timetable Builder</a></dd>
      </dl>
    </div>
    <div class="tabs-content">
      <div class="content active" id="module-finder">
        <div class="medium-3 columns">
          <div style="width: 100%;">
            <div id="search-modules-none-selected-div">
              <span class="exhibit-facet-header-title">Select Modules for Timetable</span>
            </div>
            <div id="search-modules-selected-div">
              <span class="exhibit-facet-header-title" id="search-modules-nr-selected"></span>
              <span>
                <a href="#" id="search-modules-clear-all-modules">(Clear All)</a>
              </span>
            </div>
            <input type="hidden" id="search_modules" />
          </div>
          <div data-ex-role="exhibit-facet"
               data-ex-facet-class="Exhibit.TextSearchFacet"
               data-ex-expressions=".label, .name, .description, .lecturers"
               data-ex-facet-label="Filter by Code / Title / Description / Lecturer">
          </div>
          <div data-ex-role="exhibit-facet"
               data-ex-facet-class="Exhibit.TextSearchFacet"
               data-ex-expressions=".prereqs"
               data-ex-facet-label="Filter by Prerequisite">
          </div>
          <div data-ex-role="exhibit-facet"
               data-ex-facet-class="Exhibit.HierarchicalFacet"
               data-ex-expression=".department"
               data-ex-uniform-grouping=".subtopicOf"
               data-ex-facet-label="Faculty / Department"
               data-ex-collapsible="true"
               data-ex-height="30rem">
          </div>
          <div data-ex-role="exhibit-facet"
               data-ex-facet-class="Exhibit.HierarchicalFacet"
               data-ex-expression=".lectureTimings"
               data-ex-uniform-grouping=".subtopicOf"
               data-ex-fixed-order="Monday;Monday Morning;Monday Afternoon;Monday Evening;Tuesday;Tuesday Morning;Tuesday Afternoon;Tuesday Evening;Wednesday;Wednesday Morning;Wednesday Afternoon;Wednesday Evening;Thursday;Thursday Morning;Thursday Afternoon;Thursday Evening;Friday;Friday Morning;Friday Afternoon;Friday Evening;Saturday;Saturday Morning;Saturday Afternoon;Saturday Evening"
               data-ex-others-label="No Lectures"
               data-ex-facet-label="Lecture Timings"
               data-ex-collapsible="true">
          </div>
          <div data-ex-role="exhibit-facet"
               data-ex-facet-class="Exhibit.HierarchicalFacet"
               data-ex-expression=".tutorialTimings"
               data-ex-uniform-grouping=".subtopicOf"
               data-ex-fixed-order="Monday;Monday Morning;Monday Afternoon;Monday Evening;Tuesday;Tuesday Morning;Tuesday Afternoon;Tuesday Evening;Wednesday;Wednesday Morning;Wednesday Afternoon;Wednesday Evening;Thursday;Thursday Morning;Thursday Afternoon;Thursday Evening;Friday;Friday Morning;Friday Afternoon;Friday Evening;Saturday;Saturday Morning;Saturday Afternoon;Saturday Evening"
               data-ex-others-label="No Tutorials"
               data-ex-facet-label="Tutorial Timings"
               data-ex-collapsible="true">
          </div>
          <div>
            For lecture / tutorial timing filters:
            <ul>
              <li>
                <strong>Morning:</strong>
                Lesson begins strictly before 12pm (Lessons beginning at 12pm
                are considered as Afternoon lessons)
              </li>
              <li>
                <strong>Afternoon:</strong>
                Lesson begins at any time from 12pm onwards but strictly
                before 6pm (Lessons beginning at 6pm are considered as Evening
                lessons)
              </li>
              <li>
                <strong>Evening:</strong>
                Lesson begins at 6pm or after
              </li>
            </ul>
          </div>
        </div>
        <div class="medium-9 columns">
          <div data-ex-role="exhibit-collection" data-ex-item-types="Module"></div>
          <div data-ex-role="exhibit-facet"
               data-ex-expression=".moduleType.label"
               data-ex-facet-label="Type"
               data-ex-scroll="false">
          </div>
          <div data-ex-role="exhibit-facet"
               data-ex-expression=".mc"
               data-ex-facet-label="MC"
               data-ex-sort-mode="value"
               data-ex-scroll="false">
          </div>
          <div data-ex-role="exhibit-facet"
               data-ex-expression=".level"
               data-ex-facet-label="Level"
               data-ex-sort-mode="value"
               data-ex-scroll="false">
          </div>
          <div data-ex-role="exhibit-view"
               data-ex-view-class="Exhibit.TabularView"
               data-ex-paginate="True"
               data-ex-show-toolbox="False"
               data-ex-label="Table"
               data-ex-border="0"
               data-ex-columns=".label, .details, .mc, .exam, .department"
               data-ex-column-labels="Module Code, Module Details, MC, Exam, Department">
            <table data-ex-role="lens" style="display:none;">
              <tr>
                <td><span data-ex-content=".label"></span></td>
                <td>
                  <div>
                    <strong><span data-ex-content=".name"></span></strong>
                  </div>
                  <div data-ex-if-exists=".description">
                    <span data-ex-content=".description"></span>
                  </div>
                  <div data-ex-if-exists=".lecturers">
                    <strong>Lecturers:</strong>
                    <span data-ex-content=".lecturers"
                          data-ex-formats="list { separator: ' & '; last-separator: ' & ' }"></span>
                  </div>
                  <div data-ex-if-exists=".prereqs">
                    <strong>Prerequisites:</strong>
                    <span data-ex-content=".prereqs"></span>
                  </div>
                  <div data-ex-if-exists=".preclusions">
                    <strong>Preclusions:</strong>
                    <span data-ex-content=".preclusions"></span>
                  </div>
                  <div data-ex-if-exists=".workload">
                    <strong>Workload:</strong>
                    <span data-ex-content=".workload"></span>
                  </div>
                </td>
                <td><span data-ex-content=".mc"></span></td>
                <td><span data-ex-content=".exam"></span></td>
                <td><span data-ex-content=".department"></span></td>
              </tr>
            </table>
          </div>
        </div>
      </div>
      <div class="content" id="timetable-builder">
        Timetable Builder
      </div>
    </div>
    <script src="js/modinfo.js"></script>
    <script src="js/auxmodinfo.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="js/vendor/lodash.min.js"></script>
    <script src="js/vendor/foundation.min.js"></script>
    <script src="js/vendor/exhibit3/exhibit-api.js?bundle=false&autoCreate=false"></script>
    <script src="https://cdn.jsdelivr.net/select2/3.4.6/select2.min.js"></script>
    <script>
      window.MODULES_SELECTED = {};
      $(document).foundation();
      $(document).one("scriptsLoaded.exhibit", function() {
        var DAY_INTEGER_TO_STRING = [
          "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
        ];
        // TODO: Centralize the lesson time conversion formula in a single file
        var lesson_time_to_facet_string = function(lesson) {
          var dayString = DAY_INTEGER_TO_STRING[lesson[2]];
          var startTime = 800 + 50 * lesson[3];
          var endTime = 800 + 50 * lesson[4];
          if (startTime <= 1150) {
            return dayString + " Morning";
          } else if (startTime >= 1800) {
            return dayString + " Evening";
          } else {
            return dayString + " Afternoon";
          }
        };

        var auxModulesArray = AUXMODULES.auxModules;
        var examDateStringsArray = MODULES.examDates;
        var departmentStringsArray = AUXMODULES.departments;
        var lecturersStringsArray = AUXMODULES.lecturers;
        var prereqsStringsArray = AUXMODULES.prereqs;
        var preclusionsStringsArray = AUXMODULES.preclusions;
        var workloadStringsArray = AUXMODULES.workload;
        var departmentToFacultyIndexHash = AUXMODULES.departmentToFaculty;
        var moduleCodeRegex = /^(\D+)(\d{4})\D*$/;
        var lessonTypesHash = AUXMODULES.lessonTypes;
        var lessonTypesStringsArray = MODULES.lessonType;
        var itemsArray = [];
        var modulesArray = _.map(MODULES.modules, function(modArrayRep, idx) {
          var auxModule = auxModulesArray[idx];
          var moduleCode = modArrayRep[0];
          var moduleName = modArrayRep[1];
          var level;
          var moduleCodeMatchArray;
          var moduleTypeArray = [];
          var moduleType = auxModule[2];
          var retModule;
          var timetableArray = modArrayRep[4];
          var lectureTimings = [];
          var tutorialTimings = [];
          if (moduleCode === "PH2302 / GEK2039") {
            level = 2000;
          } else {
            moduleCodeMatchArray = moduleCode.match(moduleCodeRegex);
            if (moduleCodeMatchArray === null) {
              console.log("Module Code \"" + moduleCode +
                "\" does not match regex!"
              );
              level = 0;
            } else {
              level = _.parseInt(moduleCodeMatchArray[2]);
              // subtract unneeded digits
              level -= level % 1000;
            }
          }
          if ((moduleType & MODULE_TYPE.Faculty) === MODULE_TYPE.Faculty) {
            moduleTypeArray.push("Faculty");
          }
          if ((moduleType & MODULE_TYPE.UE) === MODULE_TYPE.UE) {
            moduleTypeArray.push("Breadth / UE");
          }
          if ((moduleType & MODULE_TYPE.SS) === MODULE_TYPE.SS) {
            moduleTypeArray.push("Singapore Studies");
          }
          if ((moduleType & MODULE_TYPE.GEM) === MODULE_TYPE.GEM) {
            moduleTypeArray.push("GEM");
          }
          if (moduleTypeArray.length === 0) {
            moduleTypeArray.push("Not in CORS");
          }
          // add lecture timings
          _.filter(timetableArray, function(lessonArray) {
            switch (lessonTypesHash[
              lessonTypesStringsArray[lessonArray[1]]
            ]) {
            case "Lecture":
              lectureTimings.push(lesson_time_to_facet_string(lessonArray));
              break;
            case "Tutorial":
              tutorialTimings.push(lesson_time_to_facet_string(lessonArray));
              break;
            }
          });
          retModule = {
            type: "Module",
            label: moduleCode,
            name: moduleName,
            mc: modArrayRep[2],
            level: level,
            moduleType: moduleTypeArray,
            exam: examDateStringsArray[modArrayRep[3]],
            lectureTimings: lectureTimings,
            tutorialTimings: tutorialTimings
          };
          // add department
          if (auxModule[1] === departmentToFacultyIndexHash[auxModule[1]]) {
            // no faculty
            retModule.department = departmentStringsArray[auxModule[1]];
          } else {
            // has faculty
            // NOTE: Using an array is the key to having a nested hierarchy
            retModule.department = [departmentStringsArray[auxModule[1]]];
          }
          // only add description if it's present
          if (auxModule[0] !== -1) {
            retModule.description = auxModule[0];
          }
          // only add lecturers if the array is non-empty
          if (auxModule[3].length > 0) {
            retModule.lecturers = _.map(auxModule[3], function(lecturerIdx) {
              return lecturersStringsArray[lecturerIdx];
            });
          }
          // add prerequisites if it exists
          if (auxModule[4] !== -1) {
            retModule.prereqs = prereqsStringsArray[auxModule[4]];
          }
          // add preclusions if it exists
          if (auxModule[5] !== -1) {
            retModule.preclusions = preclusionsStringsArray[auxModule[5]];
          }
          // add workload if it exists
          if (auxModule[6] !== -1) {
            retModule.workload = workloadStringsArray[auxModule[6]];
          }
          return retModule;
        });
        itemsArray = modulesArray.concat(itemsArray);
        // add ModuleTypes
        itemsArray.push({
          type: "ModuleType",
          label: "Faculty"
        });
        itemsArray.push({
          type: "ModuleType",
          label: "Breadth / UE"
        });
        itemsArray.push({
          type: "ModuleType",
          label: "Singapore Studies"
        });
        itemsArray.push({
          type: "ModuleType",
          label: "GEM"
        });
        itemsArray.push({
          type: "ModuleType",
          label: "Not in CORS"
        });
        // add Department to Faculty structure for Facet
        _.forEach(departmentToFacultyIndexHash, function(faculty, department) {
          department = _.parseInt(department);
          if (faculty !== department) {
            itemsArray.push({
              type: "ModuleDepartment",
              label: departmentStringsArray[department],
              subtopicOf: departmentStringsArray[faculty]
            });
          }
        });
        _.forEach(DAY_INTEGER_TO_STRING, function(dayString) {
          _.forEach(["Morning", "Afternoon", "Evening"], function(s) {
            itemsArray.push({
              type: "LessonTime",
              label: dayString + " " + s,
              subtopicOf: dayString
            });
          });
        });
        window.database = Exhibit.Database.create();
        window.database.loadData({
          types: {
            Module: {
              pluralLabel: "Modules"
            }
          },
          properties: {
            mc: {
              valueType: "number"
            },
            level: {
              valueType: "number"
            },
            moduleType: {
              valueType: "item"
            }
          },
          items: itemsArray
        });
        window.exhibit = Exhibit.create();
        window.exhibit.configureFromDOM();
        // initialize select2
        $("#search_modules").select2({
          multiple: true,
          width: "100%",
          placeholder: "Type code/title to add mods",
          initSelection: function() {},
          query: function(options) {
            var i;
            var nrModules;
            var firstResults;
            var haystack;
            var searchTerm;
            var result = { results: [] }
            var resultsPerPage = 20;
            if (options.context === null) {
              nrModules = modulesArray.length;
              searchTerm = options.term.toUpperCase();
              firstResults = [];
              for (i = 0; i < nrModules; i += 1) {
                haystack = modulesArray[i].label.toUpperCase() + " " +
                  modulesArray[i].name.toUpperCase();
                if (haystack.indexOf(searchTerm) !== -1) {
                  firstResults.push({
                    id: modulesArray[i].label,
                    text: modulesArray[i].label + " " + modulesArray[i].name
                  });
                }
              }
              options.context = {
                searchResults: firstResults,
                nrResults: firstResults.length
              };
            }
            // options.page starts counting from 1
            if ((options.page - 1) * resultsPerPage < options.context.nrResults) {
              result.more = true;
              for (i = (options.page - 1) * resultsPerPage,
                   limit = Math.min(i + resultsPerPage, options.context.nrResults);
                   i < limit;
                   i += 1) {
                result.results.push(options.context.searchResults[i]);
              }
            } else {
              result.more = false;
            }
            result.context = options.context;
            options.callback(result);
          }
        });
        (function() {
          var noneSelectedDiv = $("#search-modules-none-selected-div");
          var someSelectedDiv = $("#search-modules-selected-div");
          var someSelectedDivText = $("#search-modules-nr-selected");
          someSelectedDiv.hide();
          $("#search_modules").change(function(evt) {
            var nrModulesSelected;
            if (evt.added) {
              if (noneSelectedDiv.is(":visible")) {
                noneSelectedDiv.hide();
              }
              window.MODULES_SELECTED[evt.added.id] = true;
              nrModulesSelected = _.keys(window.MODULES_SELECTED).length;
              if (!someSelectedDiv.is(":visible")) {
                // 0 modules -> 1 module
                someSelectedDivText.text("Selected 1 Module");
                someSelectedDiv.show();
              } else {
                someSelectedDivText.text("Selected " + nrModulesSelected +
                  " Modules"
                );
              }
            } else if (evt.removed) {
              delete window.MODULES_SELECTED[evt.removed.id];
              nrModulesSelected = _.keys(window.MODULES_SELECTED).length;
              if (nrModulesSelected <= 0) {
                someSelectedDiv.hide();
                noneSelectedDiv.show();
              } else if (nrModulesSelected === 1) {
                someSelectedDivText.text("Selected 1 module");
              } else {
                someSelectedDivText.text("Selected " + nrModulesSelected +
                  " Modules"
                );
              }
            }
          });
          $("#search-modules-clear-all-modules").click(function(evt) {
            evt.preventDefault();
            if (confirm(
                "Are you sure you want to clear all selected modules?"
            )) {
              window.MODULES_SELECTED = {};
              $("#search_modules").select2("val", "");
              someSelectedDiv.hide();
              noneSelectedDiv.show();
            }
          });
        })();
      });
    </script>
  </body>
</html>
